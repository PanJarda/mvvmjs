<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Typeahead example</title>
</head>
<body>
    <div id="app">
        <input type="text" data-ev="input:onInput;focusin:onFocusIn;focusout:onFocusOut" data-value="searchText">
        <ul data-foreach="hints" data-if="hinterVisible:'TRUE'">
            <li>{{name}}</li>
        </ul>
    </div>
    <script defer async id="frontend-lib" src="ko.js"></script>
    <script>
        const frontendLibScript = document.getElementById('frontend-lib');

        frontendLibScript.onreadystatechange = frontendLibScript.onload = frontendLibScriptOnLoadHandler;

        function frontendLibScriptOnLoadHandler() {
            const apiUrl = "https://api.pejskari.cz/v1/cities/";
            const limit = 10;

            const template = ko.initTmpl("app");

            const viewModel = ko.viewModel({
                searchText: "",
                hints: [],
                hinterVisible: "FALSE"
            });

            let timerId;

            const eventHandlers = {
                onInput: function onInput(viewModel, event) {
                    const inputValue = event.target.value;
                    const url = `${apiUrl}${inputValue}?l=${limit.toString()}`;
                    if (timerId) {
                        clearTimeout(timerId);
                    }
                    timerId = setTimeout(fetchHints(viewModel, url), 300);
                },
                onFocusIn: function onFocusIn(viewModel) {
                    viewModel.hinterVisible = "TRUE";
                },
                onFocusOut: function onFocusOut(viewModel) {
                    viewModel.hinterVisible = "FALSE";
                }
            };

            ko.render(template, viewModel, eventHandlers);
        }

        function fetchHints(viewModel, url) {
            return function() {
                fetch(url)
                    .then(result => result.json())
                    .then(data => {
                        const nHints = viewModel.hints.length;
                        for (let i = 0; i < nHints; i = i + 1) {
                            // you need to manually remove all the previous items
                            // because you need to tell the framework to clean the DOM
                            viewModel.hints.remove(0);
                        }
                        for (const item of data) {
                            viewModel.hints.push({name: item.name});
                        }
                        console.log(viewModel.hints);
                    });
            }
        }
    </script>
</body>
</html>
